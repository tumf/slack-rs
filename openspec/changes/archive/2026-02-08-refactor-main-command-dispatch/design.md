# 設計メモ: main ディスパッチ分解

## 方針
- Fowler の小さな変換を前提に、1 変換ずつ（Extract Function を中心）適用する。
- 振る舞い不変を最優先とし、各ステップでテストまたは同等の検証を実施する。

## 現状の課題
- `main` 関数にトップレベル分岐とサブコマンド分岐が集中し、変更時に広範囲へ影響しやすい。
- `if let Err(e)` のエラー出力と `std::process::exit` が繰り返され、終了コードの一貫性を崩しやすい。

## 提案アーキテクチャ
- `main` は次の責務のみに絞る:
  - グローバル前処理（引数正規化・非対話判定）
  - トップレベルディスパッチ呼び出し
  - 最終終了処理
- コマンドごとにハンドラ関数を設け、サブコマンド分岐を局所化する。
- 失敗処理を小さな共通ヘルパーに集約し、エラーメッセージ接頭辞と終了コードを保全する。

## トレードオフ
- メリット: 可読性向上、変更容易性向上、差分の局所化。
- デメリット: 関数数が増えるため、初見の移動コストがわずかに発生。
- 判断: 変更頻度が高い CLI 入口での保守性改善効果が上回る。

## 検証戦略
- 既存統合テストを優先活用する。
- 代表コマンド（`auth`, `api call`, `conv`, `msg`, `file`, `doctor`）で、出力と終了コードの後方互換を確認する。
- 差分適用ごとに `cargo test` と必要最小限の対象テストを実行する。
